var mails = {'chg': ["david.tirado@chg-meridian.com"],
'flowsoft': ["ruben.martinez@flowsoft.com.mx"],
'aisin': ["bjorn.schomann@awtce.de","manuel.clari@awtce.de","keiko.hakumura@aisin.co.jp","viktoria.meier@awtce.de","bjorn.schomann@awtce.de","masayuki.sato02@aisin.co.jp","shizuka.ito@aisin.co.jp","shota.araki@aisin.co.jp","tomomi.takemoto@aisin.co.jp"],
'alpha': ["miguel.palestino@kk-alpha.com","mayra.perez@kk-alpha.com","isela.villagomez@kk-alpha.com"],
'aptiv': ["luis.sesma@aptiv.com","luis.sesma@aptiv.com","anette.fischbach.vasentin@aptiv.com","alexander.suerig@aptiv.com","brigitte.alcantara@aptiv.com"],
'awtce': ["torsten.strehlau@awtce.de","viktoria.meier@awtce.de","mark.jendryschik@awtce.de","manuel.clari@awtce.de","thierry.dupas@aweurope.be","shoji.fushimi@awtce.de"],
'alpine': ["christina.politidou@alpine.de","christina.politidou@alpsalpine.com"],
'bcs': ["hana.hudecova@bcs-ais.com","timo.seydel@bcs-ais.com","jost.budde@bcs-ais.com","andre.mix@bcs-ais.com"],
'bcs automotive interface solutions': ["timo.seydel@bcs-ais.com"],
'bcs méxico': ["felix.delgado@bcs-ais.com"],
'bcs-ais': ["timo.seydel@bcs-ais.com"],
'bhtc (behr- hella thermocontrol)': ["marc.mariani@bhtc.com","francisco.saavedra@bhtc.com ","victor.zamora@bhtc.com"],
'bosch méxico': ["ana.nieto@mx.bosch.com","estefania.sanchez@mx.bosch.com","arturo.guillenlopez@mx.bosch.com"],
'bosch': ["omar.castillejos@mx.bosch.com","pascal.volk@de.bosch.com","katrin.henkel@bosch.com","thomas.schmeiser@bosch.com","jasmin.egner@bosch.com","cinthia.cuan@mx.bosch.com"],
'continental mexico': ["luis.saavedra-martinez@continental-corporation.com","marcel.bucksch@continental-corporation.com","marcel.bucksch@continental-corporation.com","martin.amparano@continental-corporation.com ","francisco.rojas@continental-corporation.com","ricardo.bricio@continental-corporation.com","abril.escobar@continental-corporation.com ","rainer.crome@continental.com","stefan.ellinger@continental-corporation.com","alexander.puchta@continental-corporation.com","daniel.beer@continental-corporation.com"],
'continental automotive gmbh': ["thomas.koermer-ext@continental-corporation.com","tatjana.schreider@continental-corporation.com"],
'ficosa adas s.l.u': ["dataprotection_spain@ficosa.com"],
'ficosa': ["alexandre.rebollal@ficosa.com ","josep.juanmarti@ficosa.com","pascual.alvarez@ficosa.com","jaume.capdevila@ficosa.com","santiago.zapater@ficosa.com ","mantonia.claret@ficosa.com","susana.saavedra@ficosa.com","xavier.palacio@ficosa.com","kotaro.kobayashi@ficosa.com"],
'ficosa north america': ["dataprotection_mexico@ficosa.com","dataprotection_mexico@ficosa.com"],
'g2video': ["guillermo_lopez@g2video.net"],
'grupo antolin silao - planta puebla': ["liz.perez@grupoantolin.com"],
'hanon systems deutschland gmbh ': ["hgrunert@hanonsystems.com","rcezanne@hanonsystems.com"],
'hella': ["eduardo.mayorga@hella.com"],
'intevaproducts': ["fwiencke@intevaproducts.com","sfoley@intevaproducts.com"],
'joynext': ["xaver.dziuba@joynext.com"],
'ktb-mexico': ["v.gamboa@ktb-mexico.com"],
'kostal': ["f.pupillo@kostal.com","u.yanez@kostal.com","ro.saucedo@kostal.com"],
'kostal mexicana': ["ro.ramos@kostal.com","al.ramirez@kostal.com"],
'lg': ["sukyoung.bang@lge.com - ya no esta en lg|"],
'lg electronics deutschland gmbh': ["heamin.song@lge.com","fabienne.minier@lge.com","kyesoo.han@lge.com","kiwook.choi@lge.com","eunjung7.kim@lge.com"],
'laird': ["uwe.gallhoff@lairdtech.com"],
'magneti mareli': ["manuel.espana@marelli.com","manuel.espana@marelli.com"],
'methode': ["mmontes@methode.com","gballesteros@methode.com","abrace@methode.com","kceleskey@methode.com"],
'methode usa': ["roland.atallah@methodegermany.com","nramon@methode.com"],
'preh': ["florian.dorst@preh.de","roberto.guerra@preh.mx","shaji.joy@preh.com"],
'panasonic': ["edgar.tajonar@us.panasonic.com"],
'plant puebla sas automotive systems': ["miguelangel.guzman@sas-automotive.com","selene.palalia@sas-automotive.com","dionisio.reyes@sas-automotive.com","luis.cervantes@sas-automotive.com","luis.ortiz@sas-automotive.com"],
'sas /lg': ["gerardo.askins@sas-automotive.com","selene.palalia@sas-automotive.com"],
'trw': ["zfservicesmexico@zf.com"],
'vw / audi na group': ["karina.ayala@zf.com","karina.ayala@zf.com"],
'valeo sistemas electronicos': ["maria-sanjuanita.lopez@valeo.com","norma.velazquez@valeo.com","roberto.vilchis.ext@valeo.com","alberto.murguia@valeo.com","karina.root@valeo.com","daniela.kuntze@valeo.com"],
'varroc': ["vlsinfo@varroclighting.com","jtomanek@varroclighting.com","jbrezina@varroclighting.com","mkoudelk@varroclighting.com","bzmij@varroclighting.com"],
'visteon': ["jcobos2@visteon.com"],
'webasto': ["uwe.wefer@webasto.com"],
'zf': ["ozan.sefedinoglou@zf.com"],
'att': [" gm423p@att.com","cv321v@att.com"],
'conexis': ["emir.ramirez@conexis.com.mx"],
'mg2020': [" marco.gerardo@mg2020.com.mx"],
'molex': ["nima.kiaeilochte@molex.com"],
'ofi': ["jose.zepeda@ofi.com"],
'prodigy': ["jc.rivera@prodigy.net.mx","lu.ramos@prodigy.net.mx"],
'sonavox': ["andreas.lartz@sonavox.eu","sandra.langhof@sonavox.eu"],
'tkpos': [" dponce@tkpos.com"],
'visteon': ["antonio.hernandez@visteon.com","mhernan5@visteon.com","fboarini@visteon.com"]}

//Para mapear a clases
class_status = {
    'Proceso': 'proceso',
    'Aclaración':'aclaracion',
    'Almacén':'almacen',
    'Cancelado':'cancelado',
    'Cotización':'cotizacion',
    'ETA':'seta',
    'Eta':'seta'
}
//Enable/disable grouping function for button
$.fn.dataTable.ext.buttons.grouping = {
    class: 'group-button',
    text: 'Activar agrupamiento',
    action: function ( e, dt, node, config ) {
        if(dt.rowGroup().enabled()){
            dt.rowGroup().enable(false).draw();
            this.text('Activar agrupamiento');
        }else{
            dt.rowGroup().enable().draw();
            this.text('Desactivar agrupamiento');
        }
    }
};

var createMail = function(e,dt,node,config){
    var vendorsFound = {};
    let indexProveedor = dt.column('Proveedor:name').index('visible');
    let indexNumParte = dt.column('Número de Parte:name').index('visible');
    let indexCant = dt.column('Cant:name').index('visible');
    let indexDescripcion = dt.column('Descripción:name').index('visible');
    let indexStatus = dt.column('Status:name').index('visible');
    let indexSeginterno = dt.column('seguimientointerno:name').index('visible');
    let pieces = dt.rows({search:'applied'}).data().toArray();
    let piecesNotFound = [];
    pieces.forEach(elem => {
        if(elem[indexStatus] ==='Cotización' && !elem[indexSeginterno].includes('CKD')){
            if(mails.hasOwnProperty(elem[indexProveedor])){
                
                    if(!vendorsFound.hasOwnProperty(elem[indexProveedor])){
                        vendorsFound[elem[indexProveedor]] = [];
                    } 
                    vendorsFound[elem[indexProveedor]].push(elem);
                
            }
            else{
                piecesNotFound.push(elem);
            }
        }
    });
    
    //sino hay resultados en el diccionario busca palabra por palabra
    let needToBeCheckByUser = [];
    if (piecesNotFound.length > 0){
        piecesNotFound.forEach(elem => {
            let found = false;
            elem[indexProveedor].toLowerCase().replaceAll('/'," ").split(' ').forEach(word => {
                let w = word.replaceAll(' ','').replaceAll('(','').replaceAll(')','');
                if (mails.hasOwnProperty(w)){
                    if(!vendorsFound.hasOwnProperty(w)){
                        vendorsFound[w] = [];
                    } 
                    vendorsFound[w].push(elem);
                    found = true;
                }
            });
            if(!found){
                needToBeCheckByUser.push(elem);
            }
        });
    }
    if (needToBeCheckByUser.length > 0){
        alert("No se pudo encontrar un proveedor para las siguientes "+ needToBeCheckByUser.length +" piezas:"+ needToBeCheckByUser.reduce((acc,curr)=>{
            acc += '\n'+ curr[indexProveedor] +' --- '+ curr[indexNumParte];
            return acc;
        },''));
        
    }
    var addPieza = (numParte,descripcion,cantidad) =>{
        return ''
        +   '<tr style="height:20.1pt">'
        +       '<td width=99 style="width:74.05pt;padding:0cm 3.5pt 0cm 3.5pt;height:20.1pt">'
        +           '<p class=MsoNormal>'
        +               '<span style="color:#1F497D;background:lime;mso-highlight:lime">'
    +                       numParte
        +               '</span>'
        +           '</p>'
        +       '</td>'
        +       '<td width=600 style="width:600.9pt;padding:0cm 3.5pt 0cm 3.5pt;height:20.1pt">'
        +           '<p class=MsoNormal>'
        +               '<span style="color:#1F497D;background:lime;mso-highlight:lime">'
    +                       descripcion
        +               '</span>'
        +           '</p>'
        +       '</td>'
        +       '<td width=99 style="width:74.15pt;padding:0cm 3.5pt 0cm 3.5pt;height:20.1pt">'
        +           '<p class=MsoNormal>'
        +               '<span style="color:#1F497D;background:lime;mso-highlight:lime">'
    +                       cantidad
        +               '</span>'
        +           '</p>'
        +       '</td>'
        +   '</tr>' ;
    }
    var makeEmail = (asunto,nombreProveedor,correos,data) => {
        var date = new Date().toLocaleDateString().replaceAll('/','.');
        var proveedor = nombreProveedor.toUpperCase();
        var emailSubject;
        if (asunto == null)  emailSubject = 'Cotizacion de Piezas //Control: '+date+'//'+proveedor;
        else emailSubject = asunto;
        var emlContent = 'To: '+correos+'\n';
        emlContent += 'Subject: '+emailSubject+'\n';
        emlContent += 'X-Unsent: 1'+'\n';
        emlContent += 'Content-Type: text/html'+'\n';
        emlContent += ''+'\n';
        emlContent += ''
        +'<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" xmlns="http://www.w3.org/TR/REC-html40"><head><meta http-equiv=Content-Type content="text/html; charset=iso-8859-1"><meta name=Generator content="Microsoft Word 15 (filtered medium)"><!--[if !mso]><style>v\:* {behavior:url(#default#VML);}'
        + 'o\:* {behavior:url(#default#VML);}'
        + 'w\:* {behavior:url(#default#VML);}'
        + '.shape {behavior:url(#default#VML);}'
        + '</style><![endif]--><style><!--'
        + '/* Font Definitions */'
        + '@font-face'
        + '    {font-family:"Cambria Math";'
        + '    panose-1:2 4 5 3 5 4 6 3 2 4;}'
        + '@font-face'
        + '    {font-family:Calibri;'
        + '    panose-1:2 15 5 2 2 2 4 3 2 4;}'
        + '@font-face'
        + '    {font-family:"VWAG TheSans";'
        + '    panose-1:2 11 5 2 5 3 2 2 2 3;}'
        + '/* Style Definitions */'
        + 'p.MsoNormal, li.MsoNormal, div.MsoNormal'
        + '    {margin:0cm;'
        + '    margin-bottom:.0001pt;'
        + '    font-size:11.0pt;'
        + '    font-family:"Calibri",sans-serif;'
        + '    mso-fareast-language:EN-US;}'
        + 'a:link, span.MsoHyperlink'
        + '    {mso-style-priority:99;'
        + '    color:#0563C1;'
        + '    text-decoration:underline;}'
        + 'a:visited, span.MsoHyperlinkFollowed'
        + '    {mso-style-priority:99;'
        + '    color:#954F72;'
        + '    text-decoration:underline;}'
        + 'span.EstiloCorreo17'
        + '    {mso-style-type:personal-compose;'
        + '    font-family:"Calibri",sans-serif;'
        + '    color:windowtext;}'
        + '.MsoChpDefault'
        + '    {mso-style-type:export-only;'
        + '    font-family:"Calibri",sans-serif;'
        + '    mso-fareast-language:EN-US;}'
        + '@page WordSection1'
        + '    {size:612.0pt 792.0pt;'
        + '    margin:72.0pt 72.0pt 72.0pt 72.0pt;}'
        + 'div.WordSection1'
        + '    {page:WordSection1;}'
        + '--></style><!--[if gte mso 9]><xml>'
        + '<o:shapedefaults v:ext="edit" spidmax="1026" />'
        + '</xml><![endif]--><!--[if gte mso 9]><xml>'
        + '<o:shapelayout v:ext="edit">'
        + '<o:idmap v:ext="edit" data="1" /></o:shapelayout></xml><![endif]--></head>'
        + '<body lang=ES-MX link="#0563C1" vlink="#954F72"><div class=WordSection1><p class=MsoNormal><span lang=EN-US style="color:#1F497D">'
        + 'Hello ' + proveedor + ' Team;'
        + '<o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="color:#1F497D"><o:p>&nbsp;</o:p></span></p><p class=MsoNormal>'
        + '<span lang=EN-US style="color:#1F497D">'
        + 'Please, I need your help with the offer for the following pieces:<o:p></o:p></span></p>'
        + '<p class=MsoNormal><span lang=EN-US style="color:#1F497D"><o:p>&nbsp;</o:p></span></p>'
        + '<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=0 style="width:318.1pt;border-collapse:collapse">'
        +   '<tr style="height:38.25pt">'
        +      '<td width=99 style="width:74.05pt;border:solid #A6A6A6 1.0pt;border-bottom:none;background:#002060;padding:0cm 3.5pt 0cm 3.5pt;height:38.25pt">'
        +          '<p class=MsoNormal>'
        +              '<span style="font-family:"Arial",sans-serif;color:white">'
    +                      'Número de Parte/part Number'
        +              '</span>'
        +          '</p>'
        +      '</td>'
        +      '<td width=400 style="width:600.9pt;border-top:solid #A6A6A6 1.0pt;border-left:none;border-bottom:none;border-right:solid #A6A6A6 1.0pt;background:#002060;padding:0cm 3.5pt 0cm 3.5pt;height:38.25pt">'
        +          '<p class=MsoNormal><span style="font-family:"Arial",sans-serif;color:white">'
    +                  'Descripción/Description'
        +          '</span></p></td>'
        +      '<td width=99 style="width:74.15pt;border-top:solid #A6A6A6 1.0pt;border-left:none;border-bottom:none;border-right:solid #A6A6A6 1.0pt;background:#002060;padding:0cm 3.5pt 0cm 3.5pt;height:38.25pt">'
        +          '<p class=MsoNormal>'
        +               '<span style="font-family:"Arial",sans-serif;color:white">'
    +                       'Cantidad/Qty.'
        +               '</span>'
        +           '</p>'
        +       '</td>'
        +   '</tr>';
        for (let elem = 0; elem < data.length; elem++) {
            emlContent += addPieza(data[elem][indexNumParte],data[elem][indexDescripcion],data[elem][indexCant]);
        }
        emlContent += '</table>'
        +'<p class=MsoNormal><span lang=EN-US style="color:#1F497D"><o:p>&nbsp;</o:p></span></p><p class=MsoNormal><span lang=EN-US style="color:#1F497D">'
        +'Your offer must to have the next information:<o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="color:#1F497D"><o:p>&nbsp;</o:p></span></p><p class=MsoNormal><span lang=EN-US style="color:#1F497D">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span style="font-size:10.0pt;color:#0070C0">International Offer</span></b><span style="color:#1F497D">/</span><b><span style="font-size:10.0pt;color:#0070C0">Cotizaciones de piezas internacionales</span></b><span style="font-size:12.0pt;font-family:"Times New Roman",serif"><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang=EN-US style="font-size:10.0pt;color:#222A35">PDF quote</span></b><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style="font-size:10.0pt;color:#222A35">Part Number/Qty.</span><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang=EN-US style="font-size:10.0pt;color:#222A35">Incoterm FCA</span></b><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style="font-size:10.0pt;color:#222A35">Piece price and total amount</span><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style="font-size:10.0pt;color:#222A35">Packing Cost, Shipping Cost and/or Logistic Cost (if It&#8217;s necessary). </span><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang=EN-US style="font-size:10.0pt;color:#C00000">DUNS number (DUNS that we need to use for payments)</span></b><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style="font-size:10.0pt;color:#222A35">All costs must have maximum 2 decimal.</span><b><span lang=EN-US style="font-size:10.0pt;color:#0070C0">&nbsp;<o:p></o:p></span></b></p><p class=MsoNormal><span lang=EN-US style="font-size:12.0pt;font-family:"Times New Roman",serif"><o:p>&nbsp;</o:p></span></p><p class=MsoNormal style="text-indent:17.4pt"><b><span lang=EN-US style="font-size:10.0pt;color:#0070C0">&nbsp;</span></b><b><span style="font-size:10.0pt;color:#0070C0">National Offer/Cotizaciones de piezas nacionales</span></b><o:p></o:p></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang=EN-US style="font-size:10.0pt;color:#222A35">PDF quote</span></b><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style="font-size:10.0pt;color:#222A35">Part Number/Qty.</span><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang=EN-US style="font-size:10.0pt;color:#222A35">Mention of Incoterm</span></b><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style="font-size:10.0pt;color:#222A35">Piece price and total amount</span><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style="font-size:10.0pt;color:#222A35">Packing Cost, Shipping Cost and/or Logistic Cost (if It&#8217;s necessary). </span><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><b><span lang=EN-US style="font-size:10.0pt;color:#C00000">SAP Supplier number (it start with 600&#8230;&#8230;&#8230;)</span></b><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="font-size:10.0pt;font-family:Symbol;color:#222A35">·</span><span lang=EN-US style="font-size:7.0pt;color:#222A35">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span lang=EN-US style="font-size:10.0pt;color:#222A35">All costs must have maximum 2 decimal</span><span lang=EN-US><o:p></o:p></span></p><p class=MsoNormal><span lang=EN-US style="color:#1F497D"><o:p>&nbsp;</o:p></span></p><p class=MsoNormal><span style="color:#1F497D">Saludos/Best Regards<o:p></o:p></span></p><p class=MsoNormal><span style="color:#1F497D"><o:p>&nbsp;</o:p></span></p><p class=MsoNormal><span style="mso-fareast-language:ES-MX"></span><b><span style="font-size:9.0pt;font-family:"Arial",sans-serif;color:#006384"><o:p></o:p></span></b></p><p class=MsoNormal><b><span style="font-size:9.0pt;font-family:"Arial",sans-serif;color:#006384">Yamil Zamora González<o:p></o:p></span></b></p><p class=MsoNormal><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#1F497D">Esp. Componentes Electrico Soporte<o:p></o:p></span></p><p class=MsoNormal><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#404040">[M-SP/344] Coor. Eléctrico/ Electrónico</span><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#203864"><o:p></o:p></span></p><p class=MsoNormal><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#404040">Servicios de Ingeniería </span>'
        + '<span lang=ES style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#404040"><o:p></o:p></span></p>'
        + '<p class=MsoNormal>'
        + '<span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#404040">Vicepresidencia Recursos Humanos </span>'
        + '<span style="font-size:8.0pt;font-family:"Times New Roman",serif;color:#404040"><o:p></o:p></span></p><p class=MsoNormal><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#4C5556"><o:p>&nbsp;</o:p></span></p><p class=MsoNormal><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#4C5556">Volkswagen Group Services México<o:p></o:p></span></p><p class=MsoNormal><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#595959">Celular +52 (222) 6 11 4142<o:p></o:p></span></p><p class=MsoNormal><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#595959"><a href="mailto:yamil.zamora@vw.com.mx">yamil.zamora@vw.com.mx</a><o:p></o:p></span></p><p class=MsoNormal><span style="font-size:8.0pt;font-family:"Arial",sans-serif;color:#595959"><a href="http://www.vw.com.mx">www.vw.com.mx</a></span><span style="font-size:10.0pt;font-family:"VWAG TheSans",sans-serif;color:#006384"><o:p></o:p></span></p><p class=MsoNormal><o:p>&nbsp;</o:p></p></div></body></html>';
    
        var textFile = null,
        makeTextFile = function (text) {
            var data = new Blob([text], {type: 'text/plain'});
            if (textFile !== null) {
              window.URL.revokeObjectURL(textFile);
            }
            textFile = window.URL.createObjectURL(data);
            return textFile;
        };
        var uint8 = new Uint8Array(emlContent.length);
        for (var i = 0; i <  uint8.length; i++){
            uint8[i] = emlContent.charCodeAt(i);
        }
        var encodedUri = makeTextFile(uint8); //encode spaces etc like a url
        // this is not jquery
        var a = document.createElement('a'); //make a link in document
        a.href = encodedUri;
        a.id = 'fileLink'+nombreProveedor;
        a.download = 'Cotizacion-'+$('.header a strong').text()+'-'+date+'-'+nombreProveedor+'.eml';
        a.style = "display:none;"; //hidden link
        document.body.appendChild(a);
        document.getElementById('fileLink'+nombreProveedor).click(); //click the link
    }
    //Prototype : makeEmail = (asunto,nombreProveedor,correos,data)
    for(const key in vendorsFound){
        makeEmail(null,key,mails[key],vendorsFound[key]);
    }
}

$(document).ready(function(){
//duplica la primera columna para anexar los inputs 
    $('#datatable thead tr')
        .clone(true)
        .appendTo('#datatable thead');
    //instancia la tabla
	var table = $('#datatable').
        // listener para ejecutar al terminar la construccion de la tabla
        on('init.dt',function(){
            var api = $('#datatable').dataTable().api();
            //make the hader for search by columns
            api.columns().eq(0).each(function (colIdx) {
                // Set the header cell to contain the input element
                var cell = $('#datatable thead td').eq(
                     $(api.column(colIdx).header()).index()
                );
                var title = $(cell).text();
                if(title!='Cant'){
                    $(cell).html('<input type="text" placeholder="' + title + '" class="hidInput" />');
                    // TODO: sinppet for dropdown list!! 
                    //$(cell).html(
                     //'<select name="select">' +
                     //    '<option value="value1">Value 1</option>' +
                     //    '<option value="value2" selected>Value 2</option>' +
                     //    '<option value="value3">Value 3</option>' +
                     //'</select>'
                     //);
                }else{
                    $(cell).html('');                    
                }
                if(!api.column(colIdx).responsiveHidden()){
                    cell.addClass('hide');
                }
            });
        })
        //tabla constructor
        .DataTable({
            // specify placement of elements around table
            dom:"<'row'<'col-sm-6'><'col-sm-6'f>>" +
            "<'row'<'col-sm-12'itr>>" +
            "<'row'<'col-sm-5'i><'col-sm-7'p>>",
            columnDefs:[
                {
                    targets:[8,9],
                    searchable:false
                }
            ],
            buttons: [
                    {
                        extend:'copy',
                        split : [
                            {
                                extend:'pdf',
                                orientation:'landscape',
                                exportOptions: {
                                    modifier: {
                                        page: 'current'
                                    },
                                    columns:[0,1,2,3,4,5,6,10,11,12,7]
                                }
                            }
                        ,   {
                                extend:'print',
                                orientation:'landscape',
                                exportOptions: {
                                    modifier: {
                                        page: 'current'
                                    },
                                    columns:[0,1,2,3,4,5,6,10,11,12]
                                }
                            },
                            'excel'
                    ]},
                    'grouping',
                    {
                        text:'Cotizar por correo',
                        action: createMail,
                    },
                    {
                        text:'modal',
                        action : ()=>{
                            $('#mm').modal('show');
                        }
                    }
            ],
            searching:true,
            paging:true,
            pageLength:200,
            lengthChange:false,
            autoWidth:false,
            info:true,
            responsive:{
                details: {
                    display: $.fn.dataTable.Responsive.display.modal( {
                        header: function ( row ) {
                            var data = row.data();
                            var api = $('#datatable').dataTable().api();
                            return '#'+data[api.column("#:name").index()] + ' Status <strong> '+data[4]+'</strong>';
                        }
                    } ),
                    renderer: (api,rowIdx,columns)=>{
                        var data = $.map( columns, function ( col, i ) {
                            return col.hidden ?
                                '<tr data-dt-row="'+col.rowIndex+'" data-dt-column="'+col.columnIndex+'">'+
                                    '<td>'+col.title+':'+'</td> '+
                                    '<td style="font-weight:bold;">'+col.data+'</td>'+
                                '</tr>' :
                                '';
                        } ).join('');
         
                        return data ?
                            $('<table/>').append( data ) :
                            false;

                    }
                }
            },
            //fixedHeader:true, <---- Causa problemas con la grafica, es mejor desactivar.
            colReorder:{
                order:[0,1,2,4,7,5,6,10,11,18,12,19,3,14,15,16,17,13,8,9,20,21,22,23,24],
                realtime: false
            },
            language:{
                search:"Buscar en toda la tabla:",
                paginate:{
                    "previous":"Anterior",
                    "next":"Siguiente"
                },
                buttons:{
                    "copy":"Copiar datos actuales",
                    "print":"Imprimir datos actuales",
                    "pdf":"Exportar datos actuales a PDF",
                    "excel":"Exportar datos actuales a excel"
                },
                "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                "infoFiltered": "(Filtrado de _MAX_ registros)",
                "infoEmpty": "Mostrando 0 a 0 de 0 registros",
                "zeroRecords": "No se encontraron coincidencias"
            },
            //listener when a new row is created
            createdRow: function (row,data,index){//it considers the original html data order
                $('td', row).eq(7).addClass(class_status[data[7]]);
                //build the info over 'actualizado hace' column
                var CalculateTime = (startDate, endDate) => {
                    let timePassed = endDate - startDate;
                    let DifferenceInDays = Math.floor(timePassed / (1000 * 3600 * 24));
                    let totalDays = DifferenceInDays;
                    let DifferenceInWeeks, DifferenceInMonths;
                    let val;
                    if (DifferenceInDays>7){
                        DifferenceInWeeks = Math.floor(DifferenceInDays/7);
                        DifferenceInDays = DifferenceInDays % 7;
                        if (DifferenceInWeeks > 4){
                            DifferenceInMonths = Math.floor(DifferenceInWeeks / 4.345);
                            DifferenceInWeeks = Math.floor(DifferenceInWeeks % 4.345);
                            val = DifferenceInMonths.toString() + ' meses '+ (DifferenceInWeeks > 1 ? DifferenceInWeeks.toString() + ' semanas':'');
                        }else{
                            val = DifferenceInWeeks.toString() + ' semana '+ DifferenceInDays.toString() + ' dias';
                        }
                    }else{
                        val = DifferenceInDays.toString() + ' dias';
                    }
                    if (isNaN(DifferenceInDays)) return [null,null];
                    else return [val,totalDays];
                }
                let semaforo = numofDays =>{
                    if (numofDays==null) return '#eb8500'
                    if (numofDays<30) return '#00a11b';
                    else if (numofDays<60) return '#ffef14';
                    else return '#ff1212';
                } 
                let [value,days] = CalculateTime(Date.parse(data[8].split("-")[0].split(' ')[0]),Date.now());
                value==null? 
                    $('td', row).eq(18).text('¡Revisar Status!'):
                    $('td', row).eq(18).text(value);
                $('td', row).eq(18).css({'font-weight': 'bold',
                    'color':'black',
                    'text-align': 'center',
                    'background-color': semaforo(days)});

                // build info for 'tiempo en proceso
                let splt = data[12].split('/');
                let dat = new Date(splt[2],splt[1]-1,splt[0]); 
                [value,days] = CalculateTime(dat.getTime(),Date.now());
                value==null? 
                    $('td', row).eq(19).text('Sin info'):    
                    $('td', row).eq(19).text(value);
                    $('td', row).eq(19).css({'text-align':'center'});
                    $('td', row).eq(18).css({'text-align':'center'});
                
            }
	    });
	table.buttons().container().appendTo('#datatable_wrapper .col-sm-6:eq(0)');

    new $.fn.dataTable.RowGroup( table );
    table.rowGroup().enable(false);
    table.rowGroup().dataSrc([0]).draw();
    
    // listener para buscar el texto sobre los texts de los headers
    $("#datatable thead td input").on( 'keyup change', function () {
        table.column( $(this).parent().index()+':visible' ).search( this.value ).draw();
    } );
    // listener para modificar el header principal de la tabla al hacer resizing
    table.on('responsive-resize', function ( e, api, columns ) {
        api.columns().eq(0).each(function (colIdx) {
                var cell = $('#datatable thead td').eq(
                     $(api.column(colIdx).header()).index()
                );
                if(columns[colIdx]){
                    cell.removeClass('hide');
                }else{
                    cell.addClass('hide');
                }
            });
    });
    // ---------- datachar instance -------------
    $('#char').css({'overflow':'scroll'});
    const data = table.column(':contains(Status)').data().reduce(function (c, p) {
        c[p] = (c[p] || 0) + 1;
        return c;
    }, {});
    const labels = Object.keys(data);
    const ctx = $('#datachar');
    const myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(data),
            datasets: [{
                label: 'No. Piezas por Status',
                data: Object.values(data),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(0, 0, 0, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(0, 0, 0, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive:true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    $('#char').append("<h3>Piezas por Seguimiento</h3><canvas id='datachar2' height=140px width=200px></canvas>");
    const ctx2 = $('#datachar2');
    const data22 = table.column('seguimientointerno:name').data().reduce(function (c, p) {
        if(p == 'Internacional CKD'){
            p = 'InternCKD'
        }else if(p.includes('Zamora')){
            p = 'Y.Zamora'
        }else if(p.includes('Chattanooga')){
            p = 'Chattanooga'
        }
        else if(p.includes('Nacional')){
            p = 'NacionalPreserie'
        }
        else if(p == 'Internacional RdM'){
            p = 'InternRdM'
        }
        c[p] = (c[p] || 0) + 1;
        return c;
    }, {});
    const data2 = Object.fromEntries(
        Object.entries(data22).sort(([,a],[,b]) => b-a)
    );
    const labels2 = Object.keys(data2);
    const myChart2 = new Chart(ctx2, {
        type: 'pie',
        data: {
            labels: Object.keys(data2),
            datasets: [{
                label: 'No. Piezas por Seguimiento',
                data: Object.values(data2),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(0, 0, 0, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(249, 64, 255, 0.4)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(0, 0, 0, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(249, 64, 255, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            
        }
    });
    $('#char').append("<h3>Piezas por Proyecto</h3><canvas id='datachar3' height=170px ></canvas>");
    const ctx3 = $('#datachar3');
    const data3 = table.column('Proyecto:name').data().reduce(function (c, p) {
        p = p.replaceAll(' ','');
        c[p] = (c[p] || 0) + 1;
        return c;
    }, {});
    const labels3 = Object.keys(data3);
    const myChart3 = new Chart(ctx3, {
        type: 'bar',
        data: {
            labels: Object.keys(data3),
            datasets: [{
                label: 'No. Piezas por Proyecto',
                data: Object.values(data3),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(0, 0, 0, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(0, 0, 0, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    $("#closechar").on('click',function() {
        $("#char").css("width","0");
        $("#table").css("marginRight","0");
    });
    $("#header_informe").on('click',function() {
        $("#char").css("width","500px");
        $("#table").css("marginRight", "500px");
    });
});
